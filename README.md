### Devops
https://www.coachdevops.com/search?q=docker+artifactory

Welcome to DevOps Coaching program. Please go through the below links to understand the following:

1. Coaching model
2. Pre-requisites before you attend classes:
   https://www.coachdevops.com/2019/01/pre-requisites-before-starting-devops.html
3. Learn the basics of Agile, devops, etc before you start attending the sessions.
4. Why are companies adopting the DevOps model?
5. What does it take to become a successful DevOps engineer?
   https://www.coachdevops.com/2021/02/top-devops-skills-for-2021-skills.html

Please click on the below link to work on pre-requisites, etc. click on the below link or copy and paste in the browser:

https://www.coachdevops.com/2019/05/welcome-package-devops-coaching.html


### Nice course on terraform:
https://www.youtube.com/watch?v=lxjgxh5XzY0&list=PLJwvtUqYDmA5Kp7mHIiP5KrVkovKwh5P4

### Devops Transformation
- Understand development processes
- Understand maturity of the organization
- Transformation of the systems

### Devops Tools
- sonarqube
- jenkins
- static code analysis
- quality gate
- 42-50 lab exercises
- Gunal lab assistant

![image](https://user-images.githubusercontent.com/27693622/232930744-9778e8b4-23e8-4a36-b0af-24d5f66052c7.png)

### Example
Before Cloud(on-Prem) for Online Shopping App
- peak usage during weekends / holidays
- Less load during rest of time
- higher cost of procuring infrastructure
- needs to plan ahead
- Dedicated server team to manage the infrastructure
- Going global takes a lot of time
![image](https://user-images.githubusercontent.com/27693622/232931468-459c8dbe-1e3f-42b6-9684-c7e9b2a3f601.png)

### Why migrate to AWS Cloud?
https://aws.amazon.com/cloud-migration/
- 20% infrastructure cost savings (autoscaling)
- 66% increase in administrator productivity
- 43% lower time to market for new features
- 29% increase in staff focus on innovation
- 45% fewer security-related incidents

These are some advantages of using cloud computing:
1. Cost Savings
2. Security
3. Flexibility
4. Mobility
5. Insight
6. Increased Collaboration
7. Quality Control
8. Disaster Recovery
9. Loss Prevention
10. Automatic Software Updates
11. Competitive Edge
12. Sustainability

Other advantages of cloud computing could include provisioning resources on demand (Elasticity).
Better resource utilization and no upfront cost. We can stop spending money to maintain a data center
and go global in minutes. There is no need of a dedicated server team to manage the infrastructure.

This video is good for cloud migration:
https://www.youtube.com/watch?v=AXQ7n7rDfFE

### What is the role of a devops Engineer?
As a devops engineer you will:
- work with IT team
- nderstand how developers work and collaborate
- Identify all manual tasks developers are doing
- create streamlined release processes
- Automate software development, deployment and release management
  - Setup CICD pipeline - to automate build and deployment
  - Automate infrastrcture setup
  - Automate Test execution process
  - Provide continuous feedback

The first challenge is to build basic Linux knowledge. We would then learn scripting in groovy, ruby, python or shell.
Next we would learn source control management. For instance, a client may want to migrate from Azure Devops to git:
https://azure.microsoft.com/en-us/products/devops/server

After that we would learn ansible and terraform for configuration management. Next we would learn Jenkins and Azure Devops. We would then learn monitoring tools such as Prometheus, Grafana, ELK stack.
Next we would learn more about Azure or AWS. At the end of the process we would learn docker, containers, kubernetes and deploy
on EKS.

All the time the focus should be on global knowledge of Devops and other tools are learnt as extra. We should be consistent
in learning to ensure that we practice.
So the list of Devops would include:
- Learning Linux Admin basics
- Understand how SDLC, Agile works
- Learn any scripting language - Groovy, Python
- Learn Git, SCM
- Learn CICD tools
- Learn configuration management tools
- Learn Containers such as Docker
- Learn any Cloud platform such as AWS, Azure, GCP
- Learn Kubernetes for Container orchestration tools

### What is SDLC and What is Devops
DevOps is an approach to improving work in the software development lifecycle (SDLC) process. 

### Lab 0

For this lab we will create two virtual servers(EC2 instances) in AWS cloud. EC2 instances are virtual servers provided by AWS.
We will create two EC2 instances:
- One EC2 instance to set up Jenkins server
- Another EC2 instance for setting up Tomcat
https://www.coachdevops.com/2023/03/provision-ubuntu-2204-ec2-instance-how.html
Lab 0 link  -->
https://www.coachdevops.com/2023/03/provision-ubuntu-2204-ec2-instance-how.html
Lab 0 - YouTube Video link:
https://www.youtube.com/watch?v=rIi8Pd5Uvbc
What does CICD mean? Why do we need to follow CICD process during software development?
https://www.coachdevops.com/2022/10/cicd-process-flow-diagram-implement.html

### Lab 1
We have now created an EC2 instance in AWS cloud. We will now setup Java, Maven and Jenkins on the EC2 instance:
https://www.coachdevops.com/2023/03/install-jenkins-on-ubuntu-2204-setup.html

![image](https://user-images.githubusercontent.com/27693622/233222175-1eb290dc-1869-40c8-b2aa-5fcc1e47f4df.png)


This link was useful for tomcat:
https://www.coachdevops.com/2020/04/install-tomcat9-on-ubuntu-1804-setup.html

![image](https://user-images.githubusercontent.com/27693622/233222116-8f152de2-cd90-48f5-90f6-b32a815bdb99.png)

This is the plan going forwards:
![image](https://user-images.githubusercontent.com/27693622/233504961-fde76d00-0037-4dc0-8f20-a83fb84a73d7.png)

### Roles and responsibilities of Devops Engineer
- Set up CICD pipeline - automate build and deployment
- Automate infrastructure setup
- Automate Test execution process
- Provide continuous feedback
- Devops Engineers should also understand how developers work and collaborate

### Top 10 Devops Tools
https://www.coachdevops.com/2020/04/top-10-devops-popular-tools-popular.html
1.    Terraform - # 1 Infrastructure automation tool
2.    Git - BitBucket/GitHub/Azure Repos - # 1 - SCM tool
3.    Jenkins, Maven, Master/Slave, Pipelines - scripted, declarative, multi branch - # 1 CI tool
4.    Docker - #1 Container platform
5.    Kubernetes - #1 container orchestration tool
6.    Ansible- #1 Configuration Management tool
7.    Azure DevOps – Microsoft platform for migrating applications to Azure Cloud
8.    SonarQube – #1 Code quality tool
9.    Slack - #1 Collaboration tool
10.  Nexus - #2 Binary repo manager 

### What is SDLC?
The Software Development Life Cycle (SDLC) is a process used by the software industry to design, develop and test high quality software. The SDLC aims to produce a high-quality software that meets or exceeds customer expectations, reaches completion within times and cost estimates.
These are the phases of the software development life cycle:
![image](https://user-images.githubusercontent.com/27693622/233507028-17f690d3-ba6b-4cdd-829c-46adbccfec9e.png)

### Differences between Agile and Waterfall
Waterfall can be described as a linear process. The process starts with requirements gathering and ends with deployment.
Agile can be described as an iterative process. Each iteration leads to gradual improvement of the product.
The problem with waterfall is that the business needs to wait a long time to see the value in Waterfall.
Waterfall is more rigid and businesses cannot change requireements. Product owners are not involved during the devlopment.
In Agile changes are allowed even after the planning is complete. Agile is iterative development where businesses can see value
through demos of the work so far. Every story in agile is tested and delivered to product owners.

Devops is about people, process and technology.

### Differences between two images:
![image](https://user-images.githubusercontent.com/27693622/233508308-28847d31-c1d0-43c9-8b22-fe751d406df5.png)

![image](https://user-images.githubusercontent.com/27693622/233504961-fde76d00-0037-4dc0-8f20-a83fb84a73d7.png)

In the first image there is no automation. There are also silos between development and operations. There is no feedback loop.
There is collaboration with slack notifications. In the second diagram there are checks before pushing the code including sonarqube, jacoco and junit. There is security through artifactory
and security scanning. The testing takes place during the deployment stage and there is a difference between deployment and release.
In the second system we are able to fail fast and trouble shoot quickly.

In the first time diagram, we see agile development with stories. There are:
- manual builds
- manual tests on the machine
- manual deployments (time consuming)
- manual code coverage
- no feedback to production teams
- no binary repo manager
- manual infrastructure setup

In this example, developers are siloed and are not collaborating effectively and are unable to find out what they have done wrong.
In the first place, it is important to define the deployment plan. Take the code from inception to release.
The main difference is during the CI/CD part of the pipeline. Each time jenkins checks the code for code quality issues. We also integrated
with notifications such as slack. We also have a binary repo manager. We have a test environment and a production environment.
The model followed is build once and deploy anywhere. There are quality gates for each starge to ensure that quality is upheld.
Every time we deploy into the QA and UAT environments. The Jar file is stored on Artifactory and there is no manual build. The build
is completed using Infrastructure as Code with Terraform and Ansible. Devops is a practice that is followed by deployment teams.
Agile is a software development methodology. Agile closes the gap between business and developers and devops closes the gap between developers
and operations. 

Continuous Integration - Find bugs early in the software development stage
Continuous Delivery - Deploy code to production environment (build once and deploy anywhere) - fixed release by May 25
Continuous Deployment - Everything is automated - as soon as developer makes change it is deployed to production

### What does Faster to market mean?
Agile with Devops can help to reduce the time to market. It helps move the product to the market place quickly.
Build and packaging is when devops is most useful. With a brand new product how is devops useful? 80% of application is already in production.
Difficult to automate the process. Many not 50% unit test coverage. It is easier for devops to implement a green field project.

### Why Devops?
- Business value
  - faster time to market
  - continuous software delivery
  - better quality due to automation
  - improved performance
  - reduced outages - shorter lead times
  - better products
- Technical value:
  - communication between teams
  - faster resolution of problems
  - increased productivity - more time available to add value (rather than fix / maintain)
  - Infrastructure as code - environment is provisioned through code rather than manually

### Devops paradigms
1. Source code management
2. Continuous integration
3. Continuous delivery
4. Infrastructure As Code
5. Continuous Deployment
6. Code Quality tools integration
7. Monitoring
8. Microservices and Containerization
9. Container Orchestration

![image](https://user-images.githubusercontent.com/27693622/233512776-3b501018-2408-440b-a9f2-7632992c700e.png)

Being good at just the first three can help get a job: git, jenkins, terraform.

These are the tools we will learn:
- Git, Github, Bitbucket, Azure Repos - Source code management
- Maven - build tools for java apps
- MSBuild - build tool for .NET
- Jenkins, Azure Devops - Continuous Integration tool
- SonarQube, Jacoco, Corbetura - Code quality tools
- Jira, Azure Board - project management tool
- Nexus, Artifactory - Binary repo manager
- Terraform, Ansible, Puppet, Chef - infrastructure automation tools
- Slack,, microsoft teams - collaboration tool
- Docker, Kubernetes - containerization and orchestration tools
- AWS, Azure, GCP - Cloud platforms
- Scripting - Groovy (pipelines), Playbooks YAML (Ansible), JSON (Terraform), Manifests (Puppet)
- AWS ECR, Azure Container Registry, DockerHub, Nexus - Container registries
- Prometheus and Grafana - Monitoring tools (New)

![image](https://user-images.githubusercontent.com/27693622/233513966-f587f649-267e-485e-80e1-c7314eed1303.png)

Sonarlint plugin locally runs the Sonarqube analysis on your code. It is a static code analysis tool. It is a plugin for eclipse and intellij.
This is quite useful for the rules on sonarqube:
https://rules.sonarsource.com/java/RSPEC-3252

![image](https://user-images.githubusercontent.com/27693622/233514223-23134295-62fd-42de-b883-a914e4206468.png)

Fortify is a security tool. Snyk is another vulnerability scanner. It is a tool that scans the code for vulnerabilities.
As a devops engineer the CyberSecurity team would be responsible for the product. Dynatrace is the responsibility of the monitoring team.
The Devops team is responsible for invoking the applications.

### Tools integration
How would we move from no automation to full cicd. First we need to set up an overview of the process.
We would then set up Jenkins and SonarQube. We would then set up Nexus to set up Artifactory. We would then slowly scale up. We
start with CI / CD, container management. 

Prospective employers will ask for you to show your github repositories. Project work is important.
We will take a problem and address that problem. When set up git bash. 

### Lab 2 - Create Java Web App using MAven and Setup Java WebApp in Github repo
This link is useful for scm:
https://www.cidevops.com/2020/03/what-is-source-code-management-what-is.html

This link is useful for setting up a Java project in Github:
https://www.coachdevops.com/2019/05/setup-repo-and-create-java-project-in.html

This is the github account that I have setup:
https://github.com/TomSpencerLondon/MyApplicationRepo

![image](https://user-images.githubusercontent.com/27693622/233873695-cf93b59f-aa10-4a74-9695-d9c6ee4f6e24.png)

### Lab 3 - CICD - Automate Build and Deployment of Java Web App using Jenkins Free Style job

We can use the steps for configuring Jenkins to automate build and deployment for the Java WebApp we already set up in GitHub using lab 2 earlier.

This link is useful for automating Builds and Deployments using Jenkins:
https://www.coachdevops.com/2019/02/create-build-job-in-jenkins-how-to.html

### Lab 4 - How to configure Webhooks in GitHub to trigger builds instantly in Jenkins?

This is to configure Webhooks in GitHub which will trigger Jenkins jobs immediately for every code check-in by the developers.
This link is useful for configuring Webhooks in GitHub:
https://www.cidevops.com/2019/02/how-to-create-webhooks-in-github-and.html

### Traditional old flow of software development
1. Manual Builds
2. Manual unit tests execution
3. Manual deployments
4. Manual code quality checks
5. Manual code coverage
6. No feedback to prod teams
7. No binary repo management
8. Manual Infrastructure setup

### Milestones
1. Automated builds
2. Automated unit tests execution
3. Automated code quality checks
4. Automated security checks
5. Automated code coverage
6. Automated deployments
7. Automated feedback to prod teams
8. Automated binary repo management
9. Automated Infrastructure setup

Jenkins is the best tool for CI / CD. Jenkins is a CI / CD tool. It is a server that runs in the background. It is a java application.
In lab 0 we created two ec2 instances. One is the Jenkins server and the other is a tomcat server.

This is a reminder of the CI/CD process
![image](https://user-images.githubusercontent.com/27693622/235010288-a584f159-a364-4e8e-a4fe-3194faae6710.png)

We will automate build, deployment and code coverage with jacoco. We will use a maven structure.
Maven gives us a project directory structure. We will use a maven project structure. We will use a maven project structure.
This link is useful for maven project structure:
https://www.cidevops.com/2020/03/what-is-maven-why-we-need-maven.html

![image](https://user-images.githubusercontent.com/27693622/235010924-84eac1cf-3376-4f9b-89b5-e87977f65dcc.png)

![image](https://user-images.githubusercontent.com/27693622/235010971-d0964747-beb5-450d-b0af-65bac2d368bb.png)


There are four ways of triggering build jobs in Jenkins:
![image](https://user-images.githubusercontent.com/27693622/235012292-8f1f57d3-ce8c-471f-a8fc-67bf435eca0e.png)

### Lab 5 - How to make code changes to trigger Jenkins builds instantly
In this exercise we want to make a code change to ensure Jenkins has started automated builds/deployments instantly.
https://www.cidevops.com/2020/02/how-to-push-code-change-into-github.html

We are using this repository for connection with jenkins:
https://github.com/TomSpencerLondon/MyApplicationRepo

We can then refresh the browser and click on Source to see the code changes you made in our git bash window. 
Now after making this code change, if we have web hooks configured correctly, it should have triggered build in Jenkins instantly.

We just changed an exclamation mark on Howdy Folks but this has been reflected on our application which we have deployed to the Tomcat instance:

![image](https://user-images.githubusercontent.com/27693622/236158207-4221fa66-ee58-4fda-bf2d-a944701e8d36.png)

### Lab 6 - Code Quality - How to setup SonarQube and Integrate with Jenkins
SonarQube is a static code quality/analysis tool which will scan application source code and find defects/issues in the code.
This link is useful for setting up sonarqube using docker:
https://www.coachdevops.com/2021/12/install-sonarqube-using-docker-install.html
All the code is directly added to the sonarqube server. We can then see the code quality issues.
I set the username and password as:
admin
password

The sonarqube ui is up and running:
![image](https://user-images.githubusercontent.com/27693622/236159826-89702e63-46e7-4d63-9d6e-d420f4b63096.png)
We now need to integrate sonarqube with jenkins. This link is useful for sonarqube Jenkins integration:
https://www.coachdevops.com/2020/04/how-to-integrate-sonarqube-with-jenkins.html

![image](https://user-images.githubusercontent.com/27693622/236160712-2f09f232-905c-4d46-8a4b-d6669241ca6a.png)

I also added the Sonarqube credentials:
![image](https://user-images.githubusercontent.com/27693622/236162134-848634ad-74c6-4592-8bd7-4968afba6e64.png)

When we push to github, we can see the sonarqube analysis:
![image](https://user-images.githubusercontent.com/27693622/236166286-680cd3b8-b1c0-4b35-9280-9c75891b3af8.png)

### Lab 7 - Nexus 3 Setup using Docker Compose and Integrate Nexus with Jenkins
Nexus is a Binary repository manager that is used for storing binaries (build output ). We will eventually integrate Nexus with Jenkins for uploading binaries files.
This link is useful to explain why binary repository managers are needed:
https://jfrog.com/whitepaper/devops-8-reasons-for-devops-to-use-a-binary-repository-manager/

We can either use nexus or artifactory as binary repo managers. Here we will use nexus.
In order to setup nexus we need to do the following:
- Create an EC2 instance with t2.medium (4 GB RAM)
- Make sure we open port 8081 in the AWS security group.
This link is useful for setting up nexus using docker:
  https://www.coachdevops.com/2022/01/install-sonatype-nexus-3-using-docker.html

We first add the EC2 instance:
- Ubuntu EC2 up and running with at least t2.medium(4GB RAM), 2GB will not work
- Port 8081, 8085 is opened in security firewall rule
- instance should have docker and docker-compose installed

These are the commands for setting up docker:
```bash
sudo hostnamectl set-hostname Nexus
sudo apt-get update
sudo apt-get install docker-compose -y
sudo usermod -aG docker $USER
sudo vi docker-compose.yml 
```
This is the docker-compose.yml file:
```yaml
version: "3"
services:
  nexus:
    image: sonatype/nexus3
    restart: always
    volumes:
      - "nexus-data:/sonatype-work"
    ports:
      - "8081:8081"
      - "8085:8085"

volumes:
  nexus-data: {}
```

We then run the following commands:
```bash
sudo docker-compose up -d 
sudo docker-compose logs --follow
```
We need to add the nexus password for authentication when we integrate with jenkins:
```bash
sudo docker exec -it ubuntu_nexus_1 cat /nexus-data/admin.password
```

This is the set up with Nexus:

![image](https://user-images.githubusercontent.com/27693622/236197756-9b02270e-d5ed-4dc3-8f96-ca8bb3d98715.png)

This link is useful for integration with Jenkins:
https://www.cidevops.com/2018/06/jenkins-nexus-integration-how-to.html

This is the nexus configuration:
![image](https://user-images.githubusercontent.com/27693622/236198021-2546a8c7-6ae4-4b4b-b570-aba591197963.png)

We also have to add a nexus credential in Jenkins:
![image](https://user-images.githubusercontent.com/27693622/236198205-28cbac32-9637-4a2c-b920-45a34d196678.png)


### Bonus Labs
These bonus labs are for ensuring that we can duplicate the deploy steps that we followed above on different environments.

#### Bonus Lab Exercise 1 - Create Java Web App using Maven & setup in Bitbucket
This link is a useful overview of version control systems:
https://www.cidevops.com/2020/03/what-is-source-code-management-what-is.html

We need to set up our bitbucket account at bitbucket.org. This link is useful for setting up ssh keys in bitbucket:
https://www.coachdevops.com/2019/09/how-to-setup-ssh-keys-in-bitbucket-and.html

#### Bonus Lab Exercise 2 - CICD - Automate Build and Deployments of Java WebApp from BitBucket using Jenkins

We have now added our WebApp to Bitbucket. I have also started the Jenkins and Tomcat EC2 instances on AWS.

We then add the configuration to Jenkins for pulling from the Bitbucket repository:
![image](https://user-images.githubusercontent.com/27693622/236209533-f03de510-2308-4d55-aecb-2f1b318dc31a.png)

For the above configuration I used the private key from the Jenkins EC2 instance and then added the public key to Bitbucket.

#### Bonus Lab Exercise 3 - How to configure webhooks in BitBucket to trigger Jenkins jobs instantly?
This link is useful on webhooks with Bitbucket:
https://www.coachdevops.com/2020/06/how-to-configure-webhooks-in-bitbucket.html

Webhooks are used to trigger Jenkins jobs when a change is made to the Bitbucket repository. This link is useful for setting up webhooks in Bitbucket:

![image](https://user-images.githubusercontent.com/27693622/236212154-5c5e0dfb-c702-4bfa-8cf3-c30df5cb4c71.png)

### Lab Exercise 8 - How to send push notifications to Slack from Jenkins (Continuous Feedback)

In this section we will look at integrating Slack with Jenkins for sending Push notifications after build in Jenkins.
Slack is a collaboration tool which agile teams use to communicate and collaborate. Slack can be integrated with Jenkins.

This link is useful for setting up Slack with Jenkins:
https://www.cidevops.com/2018/05/jenkins-slack-integration-jenkins-push.html

![image](https://user-images.githubusercontent.com/27693622/236219222-c5485fc8-33ad-41d5-bb92-5bc5c046a34a.png)

### Lab Exercise 9 - How to Trigger a Jenkins build Job from a Slack channel
We will now look at invoking a Jenkins Job from a Slack Channel.
This link is useful for setting up slack jenkins integration with build command:
https://www.coachdevops.com/2020/04/trigger-jenkins-job-from-slack-how-to.html

![image](https://user-images.githubusercontent.com/27693622/236223140-17a11c67-ba8c-46c7-a25e-b7e7d2a579c7.png)

### Lab Exercise 10 - Configure Jenkins Build Agents for Distributing loads

We will now work on using a build agent to help Jenkins achieve distributed builds.
This link is useful for setting up build agents:
https://www.coachdevops.com/2021/06/jenkins-build-agent-setup-how-to-setup.html

The advantages of the master build agent model are:
- distributed builds
- faster throughput
- quicker feedback
- scalable architecture

![image](https://user-images.githubusercontent.com/27693622/236227028-90823826-b63e-4a4b-bd10-763ccd0bee75.png)

#### Jenkins Controller
The main Jenkins server is the master. The Master's job is to handle:
- scheduling build jobs
- dispatching builds to the slaves for the actual execution
- Monitoring the slaves - possibly taking them online and offline as required
- Recording and presenting the build results
- A master instance of Jenkins can also execute build jobs directly

#### Jenkins Agent
A slave is a Java executable that runs on a remote machine. These are the characteristics of Jenkins slaves:
- Slaves hear requests from the master for build executors
- Slaves can run on a variety of operating systems
- The slave follows the master commands. For Jenkins this involves executing build jobs dispatched by the Master
- We can configure a project to always run on a particular Slave machine or a particular type of Slave machine or simply let Jenkins pick the next available Slave.

The Jenkins Master uses SSH keys to communicate with the slave. We need to create ssh keys in Jenkins agent by executing:
```bash
ssh-keygen
```
We then add the public key to the authorized_keys file in .ssh and add the private key to the Jenkins credentials.
We then use the credentials to create the agent:
![image](https://user-images.githubusercontent.com/27693622/236422470-3a4dc27b-5d28-476c-b249-d0e2b9821d04.png)


The agent is then able to authorize the controller connection:

![image](https://user-images.githubusercontent.com/27693622/236422283-93031e77-0066-4994-8b2e-73adc08e21ef.png)

When I had an issue with ssh for ec2 I used this command:
```bash
sudo chown -R ubuntu:ubuntu .ssh
```
This may have been related to some issues I was having with ssh keys for controller and agent connection.
This link is useful for setting up ssh keys for ec2:
https://askubuntu.com/questions/311558/ssh-permission-denied-publickey

```text
Sometimes the issue comes from permissions and ownership. For instance, if you want to log in as root, /root, .ssh and authorized_keys must belong to root. Otherwise, sshd won't be able to read them and therefore won't be able to tell if the user is authorized to log in.

In your home directory:

chown -R your_user:your_user .ssh
As for rights, go with 700 for .ssh and 600 for authorized_keys

chmod 700 .ssh
chmod 600 .ssh/authorized_keys
```

### Lab Exercise 11 - Create Scripted Pipeline in Jenkins for Automating Builds, Deployments and Code quality checks
We are now going to learn how to implement CI/CD using Jenkins pipelines. Pipelines are better than freestyle jobs because
you can use pipelines to write a lot of complex tasks when compared to Freestyle jobs. We can also see how long each stage takes
to execute so that we have more control compared to freestyle.

The Jenkins pipeline is written in a groovy based script that has a set of plug-ins integrated for automating build, deployment
and test execution. The pipeline defines the build process which typically includes stges for building an application, testing the application
and then deploying it. We can use the script generator to generate pipeline code for stages we don't know how to write in groovy code.
Pipelines can be categorised into two groups:
- scripted pipelines
- declarative pipelines

#### Scripted pipelines
Scripted piepelines are defined in node blocks:

```yaml

nods {
  stage('Build') {
    echo 'Building...'
  }
  stage('Test') {
    echo 'Testing...'
  }
  stage('Deploy') {
    echo 'Deploying...'
  }
}
```

#### Declarative pipelines
Declarative pipeline can be checked in as part of source control management. The code is defined in a pipeline block
and each stage can be executed in parallel in multiple build agents (Slaves):

```groovy
pipeline {
  agent { label 'slave-node' }
  stages {
    stage('checkout') {
      steps {
        git 'https://bitbucket.org/myrepo'
      }
    }
  
    stage('build') {
      tools {
        gradle 'Maven3'
      }
      steps {
        steps {
          sh 'mvn clean test'
        }
      }
    }
  }
}
```

### Our own scripted pipeline
This link is useful for scripted pipelines:
https://www.cidevops.com/2018/12/create-jenkins-pipeline-for-automating.html

We will now create our own scripted pipeline. We already have an EC2 instance on which we have deployed our Jenkins server.
A good tip is to start and stop the server as required as this means that we don't lose our configuration. We also need the following
plugins which can be installed from the Jenkins plugin page:
- slack
- jacoco
- nexus artifact uploader
- sonarqube

Next we create a new item as a pipeline job and name it MySecondPipelineJob. We can then use the pipeline syntax
generator to create our first pipeline script to download our code from github:
![image](https://user-images.githubusercontent.com/27693622/236798443-c44d2239-ee3f-4e78-b46a-77550a13947e.png)

We can then use this syntax to configure our pipeline:
![image](https://user-images.githubusercontent.com/27693622/236799963-f6cf387a-c78d-43a9-8dab-a365b0fb426a.png)

We have now successfully checked out the code from github:
![image](https://user-images.githubusercontent.com/27693622/236800163-fbce3e72-a2fd-442f-9f58-965667612ecc.png)

Next we will configure our build and code quality scan:

```groovy
node {
    def mvnHome = tool 'Maven3'
    stage ("checkout") {
        checkout scmGit(branches: [[name: '*/main']], extensions: [], userRemoteConfigs: [[credentialsId: 'e5ab6423-0076-44e3-aea7-c319e898302a', url: 'git@github.com:TomSpencerLondon/MyApplicationRepo.git']])
    }
    
    stage('build') {
        sh "${mvnHome}/bin/mvn clean install - f MyWebApp/pom.xml"
    }
    
    stage('Code Quality scan') {
        withSonarQubeEnv('SonarQube') {
            sh "${mvnHome}/bin/mvn -f MyWebApp/pom.xml sonar:sonar"
        }
    }
}
```

Here we have defined mvnHome to refer to the Maven3 tool that we added in Dashboard > Manage Jenkins > Tools:

![image](https://user-images.githubusercontent.com/27693622/236801337-677e6c6f-16e9-468f-9bd4-061b8773c0b8.png)


We now add the rest of our configuration:
```groovy
node {

    def mvnHome = tool 'Maven3'
    stage ("checkout")  {
       copy code here which you generated from step #6
    }

   stage ('build')  {
    sh "${mvnHome}/bin/mvn clean install -f MyWebApp/pom.xml"
    }

     stage ('Code Quality scan')  {
       withSonarQubeEnv('SonarQube') {
       sh "${mvnHome}/bin/mvn -f MyWebApp/pom.xml sonar:sonar"
        }
   }
  
   stage ('Code coverage')  {
       jacoco()
   }

   stage ('Nexus upload')  {
        nexusArtifactUploader(
        nexusVersion: 'nexus3',
        protocol: 'http',
        nexusUrl: 'nexus_url:8081',
        groupId: 'myGroupId',
        version: '1.0-SNAPSHOT',
        repository: 'maven-snapshots',
        credentialsId: '2c293828-9509-49b4-a6e7-77f3ceae7b39',
        artifacts: [
            [artifactId: 'MyWebApp',
             classifier: '',
             file: 'MyWebApp/target/MyWebApp.war',
             type: 'war']
        ]
     )
    }
   
   stage ('DEV Deploy')  {
      echo "deploying to DEV Env "
      deploy adapters: [tomcat9(credentialsId: '4c55fae1-a02d-4b82-ba34-d262176eeb46', path: '', url: 'http://your_tomcat_url:8080')], contextPath: null, war: '**/*.war'

    }

  stage ('Slack notification')  {
    slackSend(channel:'channel-name', message: "Job is successful, here is the info -  Job '${env.JOB_NAME} [${env.BUILD_NUMBER}]' (${env.BUILD_URL})")
   }

   stage ('DEV Approve')  {
            echo "Taking approval from DEV Manager for QA Deployment"     
            timeout(time: 7, unit: 'DAYS') {
            input message: 'Do you approve QA Deployment?', submitter: 'admin'
            }
     }

stage ('QA Deploy')  {
     echo "deploying into QA Env " 
deploy adapters: [tomcat9(credentialsId: '4c55fae1-a02d-4b82-ba34-d262176eeb46', path: '', url: 'http://your_tomcat_url:8080')], contextPath: null, war: '**/*.war'

}
  stage ('QA notify')  {
    slackSend(channel:'channel-name', message: "QA Deployment was successful, here is the info -  Job '${env.JOB_NAME} [${env.BUILD_NUMBER}]' (${env.BUILD_URL})")
  }

  stage ('QA Approve')  {
    echo "Taking approval from QA manager"
    timeout(time: 7, unit: 'DAYS') {
      input message: 'Do you want to proceed to PROD Deploy?', submitter: 'admin,manager_userid'
    }
  }

  stage ('PROD Deploy')  {
    echo "deploying into PROD Env "
    deploy adapters: [tomcat9(credentialsId: '4c55fae1-a02d-4b82-ba34-d262176eeb46', path: '', url: 'http://your_tomcat_url:8080')], contextPath: null, war: '**/*.war'

  }
}
```

After adding the correct urls and credentials we have a successful build:
![image](https://user-images.githubusercontent.com/27693622/237062520-a1d8c098-2af5-42ec-b592-5b467465f7a9.png)

### Lab 12 - Create Declarative Pipeline - Jenkinsfile to Automate builds, Deployments and Code quality checks
This link is useful for the difference between scripted and declarative pipelines:
https://www.cidevops.com/2019/05/jenkins-pipelines-cicd-pipelines.html


#### Scripted pipeline
- Scripted pipeline is traditional way of writing pipeline using groovy scripting in Jenkins UI.
- stricter groovy syntax
- each stage can not be executed in parallel in multiple build agents(Slaves) that easily.
- Code is defined within a node block

```groovy
// Scripted pipeline
node {
    stage('Build') {
        echo 'Building....'
    }
    stage('Test') {
        echo 'Building....'
    }
    stage('Deploy') {
        echo 'Deploying....'
    }
}
```

#### Declarative Pipeline (Jenkinsfile)

- New feature added to Jenkins where you create a Jenkinsfile and check in as part of SCM such as Git.
- simpler groovy syntax
- Code is defined within a 'pipeline' block
- each stage can be executed in parallel in multiple build agents(Slaves)

```groovy
// Declarative pipeline
pipeline {
    agent { label 'slave-node' }
    stages {
        stage('checkout') {
            steps {
                git 'https://bitbucket.org/myrepo'
            }
        }
        stage('build') {
            tools {
                gradle 'Maven3'
            }
            steps {
                sh 'mvn clean test'
            }
        }
    }
}

```



